if (typeof Builder === 'undefined') {
  Builder = require( 'builder' ).Builder;
}

(function(Builder) {
  
  function View( controller, factory ) {

    var instance = this
      , composite;

    this.buildComposite = function() {
      var builder = new Builder( factory );
      this.composite = builder.buildComposite( controller );
    };
  
    Element.call( this );
    if (typeof controller !== 'undefined') {
      this.buildComposite();
    }
  }

  View.prototype = new Element();


  function LayerView( controller, factory ) {

    var instance = this;

    View.call( this, controller, factory );

    this.layoutVertical = function( top ) {
      
      for (component in instance.composite) {
        var element = instance.composite[component];
        element.bounds.setHeight( this.bounds.size.y );
        element.layoutVertical( top );
      }
      return View.prototype.layoutVertical.call( this, top );
    };

    this.layoutHorizontal = function( left ) {
      for (component in instance.composite) {
        var element = instance.composite[component];
        element.bounds.setWidth( this.bounds.size.x );
        element.layoutHorizontal( left );
      }
      return View.prototype.layoutHorizontal.call( this, left ); 
    };
  }

  LayerView.prototype = new View();


  function RowView( controller, factory ) {

    var instance = this;

    View.call( this, controller, factory );

    this.layoutVertical = function( top ) {
      
      for (component in instance.composite) {
        var element = instance.composite[component];
        element.bounds.setHeight( this.bounds.size.y );
        element.layoutVertical( top );
      }
      return View.prototype.layoutVertical.call( this, top );
    };

    this.layoutHorizontal = function( left ) {
      var fill = this.bounds.size.x;
      for (component in instance.composite) {
        var l
          , element = instance.composite[ component ];
        element.bounds.setWidth( fill );
        l = element.layoutHorizontal( left );
        fill -= l - left;
        left = l;
      }
      return View.prototype.layoutHorizontal.call( this, left ); 
    };

    this.setHeight = function( h ) {
      for (component in instance.composite) {
        instance.composite[ component ].bounds.setHeight( h );
      }
    }; 
  }

  RowView.prototype = new View();

  function ColumnView( controller, factory ) {

    var instance = this;

    View.call( this, controller, factory );
    
    this.layoutVertical = function( top ) {
      
      for (component in instance.composite) {
        if (instance.composite[component] instanceof Array) {
          var element = instance.composite[ component ];
          element.forEach( function( e ) {
            e.bounds.setHeight( instance.bounds.size.y );
            top = e.layoutVertical( top );
          } );
        }
        else {
          var element = instance.composite[ component ];
          element.bounds.setHeight( instance.bounds.size.y );
          top = element.layoutVertical( top );
        }
      }
      return View.prototype.layoutVertical.call( this, top );
    };

    this.layoutHorizontal = function( left ) {
      for (component in instance.composite) {
        var element = instance.composite[ component ];
        if (element instanceof Array) {
          element.forEach( function( e ) { 
            e.layoutHorizontal( left );
          } );
        }
        else {
          var element = instance.composite[ component ];
          element.bounds.setWidth( this.bounds.size.x );
          element.layoutHorizontal( left );
        }
      }
      return View.prototype.layoutHorizontal.call( this, left ); 
    };
  }

  ColumnView.prototype = new View();

  exports.View = View;
  exports.LayerView = LayerView;
  exports.RowView = RowView;
  exports.ColumnView = ColumnView;

})(Builder);